# ????.Redis.TypedKeys

??????? Redis ???????? ? ???? ??? ???? .NET 9. ????? ??? ?????? ???????????: ????????? ????? ????? ?? ????????????? ???????? ? ????????? ??? Pub/Sub — ????? ?? StackExchange.Redis.

- .NET: 9
- ?????? Redis: StackExchange.Redis 2.x
- ????: Santel.Redis.TypedKeys

[English README](./README.md)

## ????????
- ???????? ???????? ???? ???? ???? ? ??: `RedisKey<T>` ? `RedisHashKey<T>`
- ?? ??????? ????? (`RedisDBContextModule`) ???? ????? ???? ??????
- ?? ????????????? ??????? ???? ?? ????/???? ?? ????? ????
- ????????? ??? Pub/Sub ???? ????? ?? ??? ?????????
- ????? ?????????? ?????? ???? ?? ????
- ???????: ????????? ??? ??????? DB? ????? ??????? ?? ????????? ??????????? ????? ???

## ???
```
dotnet add package Santel.Redis.TypedKeys
```

## ??????????
- .NET 9
- ???? Redis

---

## ???? ????

1) ??????? (????? ?? ?? `RedisDBContextModule` ??? ??????) ?? ????? ???? ? ?????? ?? ????? ????:
```csharp
using Newtonsoft.Json;
using Santel.Redis.TypedKeys;
using StackExchange.Redis;

public class AppRedisContext : RedisDBContextModule
{
    // DB 0: ???? ????? ???????
    public RedisKey<string> AppVersion { get; set; } = new(0);

    // DB 1: ??????? ??????? ?? ?? (field = userId)
    public RedisHashKey<UserProfile> Users { get; set; } = new(1);

    // DB 2: ???????? ?? ?????????? ??????
    public RedisHashKey<Invoice> Invoices { get; set; } = new(2,
        serialize: inv => JsonConvert.SerializeObject(inv, Formatting.None),
        deSerialize: s => JsonConvert.DeserializeObject<Invoice>(s)!);

    // ??????? ?? ??????????? ??????? ???? ??????/????? (???????? ???? Replica) ?? ??????? ?????????????? ?? ?????
    public AppRedisContext(IConnectionMultiplexer writer,
                           IConnectionMultiplexer reader,
                           ILogger<AppRedisContext> logger,
                           string? prefix,
                           bool keepDataInMemory = true,
                           string? channelName = null)
        : base(writer, reader, keepDataInMemory, logger, prefix, channelName) { }

    // ??????? ?????????????? (?????? = ?????)
    public AppRedisContext(IConnectionMultiplexer mux,
                           ILogger<AppRedisContext> logger,
                           string? prefix,
                           bool keepDataInMemory = true,
                           string? channelName = null)
        : base(mux, keepDataInMemory, logger, prefix, channelName) { }
}

public record UserProfile(int Id, string Name)
{
    public UserProfile() : this(0, string.Empty) { }
}
public record Invoice(string Id, decimal Amount);
```

2) ??? ?? DI
```csharp
using Microsoft.Extensions.DependencyInjection;
using Santel.Redis.TypedKeys;
using StackExchange.Redis;

var services = new ServiceCollection();
services.AddSingleton<IConnectionMultiplexer>(sp =>
    ConnectionMultiplexer.Connect("localhost:6379"));
services.AddLogging();

// ??? ??????? ???????? ?? ??????? ?????.
// ????? ??????? ??????????????? ??? ??-??????????? ?????? ??????.
services.AddRedisDBContext<AppRedisContext>(
    keepDataInMemory: true,
    prefix: "Prod",
    channelName: "Prod");
```

3) ???????
```csharp
var sp = services.BuildServiceProvider();
var ctx = sp.GetRequiredService<AppRedisContext>();

// ???? ????
ctx.AppVersion.Write("1.5.0");
string? version = ctx.AppVersion.Read();

// ??: ?? ????
ctx.Users.Write("42", new UserProfile(42, "Alice"));
var alice = ctx.Users.Read("42");

// ??: ????? ??????? + ?????? "all" ???? ????? ?????????????
await ctx.Users.WriteAsync(new Dictionary<string, UserProfile>
{
    ["1"] = new(1, "Bob"),
    ["2"] = new(2, "Carol")
}, forceToPublish: true); // ??? channelName ????? ??? ????? "Users|all" ????? ??????

// ??: ?????? ???????
var batch = ctx.Users.Read(new[] { "1", "2" });
```

---

## ????????? ???? ? Pub/Sub
- ?????????: ??? `prefix` ????/null ???? ? `PropertyName`? ?? ??? ??? ???? ? `${prefix}_{PropertyName}`
- ????? ??????: ?? `channelName` ????? ??????
  - `RedisKey<T>`: ??? ????
  - `RedisHashKey<T>` ???? ????: `HashName|{field}`
  - `RedisHashKey<T>` ?????? ???: `HashName|all`

?????? Subscribe:
```csharp
var sub = readerMux.GetSubscriber();
await sub.SubscribeAsync("Prod", (ch, msg) =>
{
    var text = (string)msg;
    if (text.EndsWith("|all"))
    {
        // ????? ?? ?? ?? ??????
    }
    else if (text.Contains('|'))
    {
        var parts = text.Split('|'); // parts[0] = ??? ??? parts[1] = ????
        // ????? ?? ?? ????
    }
    else
    {
        // ????? ?? ???? ????
    }
});
```

????: ?????? (Publish) ?? ??????????? ????? ????? ??????? Subscribe ???????? ?? ??????????? ?????? ????.

---

## ?? ? ?????
????/??????? ?? ??????? `keepDataInMemory` ?? ?????? ?? ??????? DI.
- `RedisKey<T>`: ????? `RedisDataWrapper<T>` ??????/????????? ?? ??????
- `RedisHashKey<T>`: ???????? ?? ???? ??????? ???? ?? ???????

????? ?????:
```csharp
ctx.AppVersion.ForceToReFetch();        // ????? ?? ???? ????
ctx.Users.ForceToReFetch("42");        // ????? ?? ?? ????
ctx.Users.ForceToReFetchAll();          // ????? ?? ???? ??????
ctx.Users.DoPublishAll();               // ?????? "Users|all" ??? ?????
```

---

## ??????? ???? API

RedisKey<T>
- ????? ?? ???????: `public RedisKey<T> SomeKey { get; set; } = new(dbIndex);`
- ?????: `Write(T value)` / `Task WriteAsync(T value)`
- ??????: `T? Read()` / `Task<T?> ReadAsync()`
- ?????? ???? ???? (???????): `RedisDataWrapper<T>? ReadFull()`
- ????: `bool Exists()`
- ???: `bool Remove()` / `Task<bool> RemoveAsync()`
- ??: `ForceToReFetch()`

RedisHashKey<T>
- ?????: `public RedisHashKey<T> SomeHash { get; set; } = new(dbIndex, serialize?, deSerialize?);`
- ????? ?? ????: `Write(string field, T value)` / `Task WriteAsync(string field, T value)`
- ????? ???????: `Task<bool> WriteAsync(IDictionary<string,T> items, bool forceToPublish = false, int maxChunkSizeInBytes = 1024*128)`
- ?????? ?? ????: `T? Read(string field)` / `Task<T?> ReadAsync(string field)`
- ?????? ????????: `IDictionary<string,T?> Read(IEnumerable<string> fields)`
- ???: `Task<bool> RemoveAsync(string field)` / ??? ????????
- ??? ?? ??: `Task<bool> RemoveAsync()`
- ??: `ForceToReFetch(string field)` / `ForceToReFetchAll()`
- ?????? ???: `DoPublishAll()`

????? ???? ???????
- `Task<long> GetDbSize(int database)`
- `Task<(List<string>? Keys, long Total)> GetHashKeysByPage(int database, string hashKey, int pageNumber = 1, int pageSize = 10)`
- `Task<string?> GetValues(int database, string key)` (?????? ????? ??? ?? ???? ????)

---

## ????????? (??????? ??)
```csharp
var (fields, total) = await ctx.GetHashKeysByPage(
    database: 1,
    hashKey: ctx.Users.FullName,
    pageNumber: 2,
    pageSize: 25);
```

---

## ???????? ?? ????? ???????
???? ??????????? ????? ????????? `maxChunkSizeInBytes` ?? ????? ???? ?? ?????? ?? ??? ??? ????? ???:
```csharp
await ctx.Invoices.WriteAsync(
    items: bigDictionary,
    forceToPublish: false,
    maxChunkSizeInBytes: 256 * 1024);
```
??? ??? ?????? ???????? ?? ?????? ????? ???? ?? ???? ??????.

---

## ?????????? ??????
????????? ???? ?? ???? ?????????? ?????? ????? ????. ??????? ?????? ?? `RedisDataWrapper<T>` ?? ??????? ????? ???????.
```csharp
public RedisHashKey<Invoice> Invoices { get; set; } = new(2,
    serialize: inv => JsonSerializer.Serialize(inv),
    deSerialize: s => JsonSerializer.Deserialize<Invoice>(s)!);
```

---

## ????? ??????? (DI)
??????? ????? ??? ????? ???:
```csharp
services.AddRedisDBContext<AppRedisContext>(
    keepDataInMemory: true,
    prefix: "Prod",          // ?????? ??? ????: Prod_{Property}
    channelName: "Prod");    // ??? ????? Pub/Sub (???? ????????????? ????/Null)
```
??????? ???????? ??? ????????? ?? ?????? ??????:
1) `(IConnectionMultiplexer mux, bool keepDataInMemory, ILogger logger, string? prefix, string? channelName)`
2) `(IConnectionMultiplexer write, IConnectionMultiplexer read, bool keepDataInMemory, ILogger logger, string? prefix, string? channelName)`

?? ???? ???? ????????? ??? ???? ????? ????.

---

## ?????? ???????
- ???? ??? ??????? ????? ?? ??????????? ???? ?? ?? Replica ???? ??? ??????? ????.
- `channelName` ?? ?? ?? ????/?????? ???? ??? ????? ?? ????? ?? ????.
- ?? ?? ?????? ???? Pub/Sub ?? `ForceToReFetch(All)` ???? ??????? ????? ??????? ????.
- ???? ??????? ??????? ?? ?????? Async ??????? ????.
- ???? ????????? ????? `maxChunkSizeInBytes` ????? ????? ????.

---

## ??? ?????
- ?????? Pub/Sub ?????? ???????? ????? ???? `channelName` ????? ??? ? ?????? ??? ?????? ????? ????? ??????.
- ????? ???? ????????? ??????? `keepDataInMemory` ? ????? ?? ?? ???????? ?? ????? ????.
- ???????? ?? ????????? ????? ????? `maxChunkSizeInBytes` ?? ???? ????.
- ??????? DB ??? ???? ???? ??? ???? ???????? ?????????? ????? `DBSIZE` ?? ??????? ????.

---

## ?????????
- ???????? ???: .NET 9
- ?????? Redis: StackExchange.Redis 2.7.x

---

## ????
MIT

## ??????
?? Issue ? PR ??????? ??????.
