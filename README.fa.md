# Santel.Redis.TypedKeys (????? ????)

??????? Redis ??????? ????? ???? .NET 9. ???? ???? ??? ?? key/hash ??????? ???: ????? ????? cache ???? ?????? ? pub/sub ???. ?????? ??? StackExchange.Redis ?????????? ???.

- .NET: 9
- Redis client: StackExchange.Redis 2.x
- Package: Santel.Redis.TypedKeys

[English README](./README.md)

## ?? ???? ?????
- `RedisKey<T>` ? `RedisHashKey<T>` ???? ??? ?? key ? hash ??????? ?????
- ?? context ????? (`RedisDBContextModule`) ?? ??? ???? key?? ?? ????? ??????
- cache ??????? ???? key ? field?? (?????? ???? ??????)
- pub/sub ??? ???? invalidation ??? ??? ?????
- ????? serialization ?????? ???? ?? key
- ???????? ?????: paging ???? hash? ????? DB size? bulk write ?? chunk ????? ? ??? ??????? ??? ???? ?????

## ???
```
dotnet add package Santel.Redis.TypedKeys
```

## ????????
- .NET 9
- ?? ???? Redis ?? ???? ????

---

## ???? ????

1) ??? context ???? ?? ???? (?? `RedisDBContextModule` ??????? ??) ? key?? ?? ????? ??:
```csharp
using Newtonsoft.Json;
using Santel.Redis.TypedKeys;
using StackExchange.Redis;

public class AppRedisContext : RedisDBContextModule
{
    // DB 0: ?? key ???? (string)
    public RedisKey<string> AppVersion { get; set; } = new(0);

    // DB 1: user profile?? ???? ?? hash (field = userId)
    public RedisHashKey<UserProfile> Users { get; set; } = new(1);

    // DB 2: invoice?? ?? serialization ??????
    public RedisHashKey<Invoice> Invoices { get; set; } = new(2,
        serialize: inv => JsonConvert.SerializeObject(inv, Formatting.None),
        deSerialize: s => JsonConvert.DeserializeObject<Invoice>(s)!);

    // ??? reader ? writer ??? ???? (????? replica)? ?? ??? ?????? ??????? ??
    public AppRedisContext(IConnectionMultiplexer writer,
                           IConnectionMultiplexer reader,
                           ILogger<AppRedisContext> logger,
                           string? prefix,
                           bool keepDataInMemory = true,
                           string? channelName = null)
        : base(writer, reader, keepDataInMemory, logger, prefix, channelName) { }

    // ??? ?? multiplexer ????? ?? ??? ??????? ?? (read = write)
    public AppRedisContext(IConnectionMultiplexer mux,
                           ILogger<AppRedisContext> logger,
                           string? prefix,
                           bool keepDataInMemory = true,
                           string? channelName = null)
        : base(mux, keepDataInMemory, logger, prefix, channelName) { }
}

public record UserProfile(int Id, string Name)
{
    public UserProfile() : this(0, string.Empty) { }
}
public record Invoice(string Id, decimal Amount);
```

2) ???? ??? DI ???? ??
```csharp
using Microsoft.Extensions.DependencyInjection;
using Santel.Redis.TypedKeys;
using StackExchange.Redis;

var services = new ServiceCollection();
services.AddSingleton<IConnectionMultiplexer>(sp =>
    ConnectionMultiplexer.Connect("localhost:6379"));
services.AddLogging();

// ??? context ??????? ?????. ??? constructor ???multiplexer ?? ?????? ??????? ??? ??????.
services.AddRedisDBContext<AppRedisContext>(
    keepDataInMemory: true,
    prefix: "Prod",
    channelName: "Prod");
```

3) ???????
```csharp
var sp = services.BuildServiceProvider();
var ctx = sp.GetRequiredService<AppRedisContext>();

// key ????
ctx.AppVersion.Write("1.5.0");
string? version = ctx.AppVersion.Read();

// hash: ?? field
ctx.Users.Write("42", new UserProfile(42, "Alice"));
var alice = ctx.Users.Read("42");

// hash: ????? ????? ???? ?? ?? + publish ???? invalidation ???? ????????
await ctx.Users.WriteAsync(new Dictionary<string, UserProfile>
{
    ["1"] = new(1, "Bob"),
    ["2"] = new(2, "Carol")
}, forceToPublish: true); // ??? channelName ?? ??? ????? "Users|all" ????? ????

// hash: ????? ????? field ?? ??
var batch = ctx.Users.Read(new[] { "1", "2" });
```

---

## ????????? key ? Pub/Sub
- ????????? key: ??? `prefix` ???? ???? => `PropertyName`? ????? => `${prefix}_${PropertyName}`
- publish ??? ?? channel?? ????? ?? `channelName` ????
  - ???? `RedisKey<T>`: ??? ??? key publish ????
  - ???? `RedisHashKey<T>` (?? field): `HashName|{field}`
  - ???? publish-all: `HashName|all`

?????? subscribe:
```csharp
var sub = readerMux.GetSubscriber();
await sub.SubscribeAsync("Prod", (ch, msg) =>
{
    var text = (string)msg;
    if (text.EndsWith("|all"))
    {
        // ????? ?? cache ????? ?? ??? hash ?? ???? ??
    }
    else if (text.Contains('|'))
    {
        var parts = text.Split('|'); // parts[0] = ??? hash? parts[1] = field
        // ????? cache ???? field ?? ???? ??
    }
    else
    {
        // key ???? ????? ????? cache? ?? ???? ??
    }
});
```

????: publish ?? write multiplexer ????? ????? subscribe ??????? ?? read multiplexer ????.

---

## Cache ? invalidate
?? `keepDataInMemory` ???? ?? ?????? ??.
- `RedisKey<T>`: ????? ????? (???? `RedisDataWrapper<T>`) cache ????
- `RedisHashKey<T>`: ?? field ??? ??? cache ????

???????? invalidate:
```csharp
ctx.AppVersion.ForceToReFetch();        // cache key ???? ?? ???? ??
ctx.Users.ForceToReFetch("42");        // cache ?? field ?? ???? ??
ctx.Users.ForceToReFetchAll();          // cache ???? field??? ??? hash ?? ???? ??
ctx.Users.DoPublishAll();               // "Users|all" ?? publish ??
```

---

## API Cheatsheet (????? ???????)

RedisKey<T>
- ????? ???? context: `public RedisKey<T> SomeKey { get; set; } = new(dbIndex);`
- ?????: `Write(T value)` / `Task WriteAsync(T value)`
- ?????: `T? Read()` / `Task<T?> ReadAsync()`
- ????? ???? ?? ???????: `RedisDataWrapper<T>? ReadFull()`
- ?? ????: `bool Exists()`
- ???: `bool Remove()` / `Task<bool> RemoveAsync()`
- ?????? cache: `ForceToReFetch()`

RedisHashKey<T>
- ?????: `public RedisHashKey<T> SomeHash { get; set; } = new(dbIndex, serialize?, deSerialize?);`
- ????? ?? field: `Write(string field, T value)` / `Task WriteAsync(string field, T value)`
- ????? bulk: `Task<bool> WriteAsync(IDictionary<string,T> items, bool forceToPublish = false, int maxChunkSizeInBytes = 1024*128)`
- ????? ?? field: `T? Read(string field)` / `Task<T?> ReadAsync(string field)`
- ????? ????? field: `IDictionary<string,T?> Read(IEnumerable<string> fields)`
- ??? field: `Task<bool> RemoveAsync(string field)` / ??? ????? field
- ??? ?? hash: `Task<bool> RemoveAsync()`
- ?????? cache: `ForceToReFetch(string field)` / `ForceToReFetchAll()`
- publish-all: `DoPublishAll()`

??????? context
- `Task<long> GetDbSize(int database)`
- `Task<(List<string>? Keys, long Total)> GetHashKeysByPage(int database, string hashKey, int pageNumber = 1, int pageSize = 10)`
- `Task<string?> GetValues(int database, string key)` (?????? raw value ?? ?? key ????)

---

## Paging ???? (field??? hash)
```csharp
var (fields, total) = await ctx.GetHashKeysByPage(
    database: 1,
    hashKey: ctx.Users.FullName,
    pageNumber: 2,
    pageSize: 25);
```

---

## Bulk write chunking
???? ??????? ???? ????????? ?? `maxChunkSizeInBytes` ??????? ????????? ??? ?? ?????? ????? ???:
```csharp
await ctx.Invoices.WriteAsync(
    items: bigDictionary,
    forceToPublish: false,
    maxChunkSizeInBytes: 256 * 1024);
```
??? ??? ?????? timeout ?? ?? ??????.

---

## Custom serialization
???? ?? key ??????? serializer ???? ?? ???. ???? ????? ???? `RedisDataWrapper<T>` ????? ???? ?? timestamp ?? ????? ????.
```csharp
public RedisHashKey<Invoice> Invoices { get; set; } = new(2,
    serialize: inv => JsonSerializer.Serialize(inv),
    deSerialize: s => JsonSerializer.Deserialize<Invoice>(s)!);
```

---

## DI (??? ?? Dependency Injection)
??????? ????? ?????:
```csharp
services.AddRedisDBContext<AppRedisContext>(
    keepDataInMemory: true,
    prefix: "Prod",          // ???? prefix ??? key: Prod_{Property}
    channelName: "Prod");    // pub/sub channel (??? ???? ???? publish ??????? ????)
```
????????? ?? ?? ??? ????? ?????? ??????:
1) `(IConnectionMultiplexer mux, bool keepDataInMemory, ILogger logger, string? prefix, string? channelName)`
2) `(IConnectionMultiplexer write, IConnectionMultiplexer read, bool keepDataInMemory, ILogger logger, string? prefix, string? channelName)`

??? wiring ???? ???????? ??????? ???? ?? ??? ???.

---

## ??????? ? Best Practices
- ???? read ????? ?? read multiplexer ?? ?? replica ???? ???? ??? ??????.
- `channelName` ?? ???? ?? ????/tenant ???? ??? ??? ?? ????? ???.
- ??? ?? ?????? ???? pub/sub? ?? `ForceToReFetch(All)` ????? ?? ???? ??.
- ??? ??????? ???? ?? async ??????? ??.
- ???? bulk write??? ???? ????? `maxChunkSizeInBytes` ????? ????.

---

## ???????? (Troubleshooting)
- ???? pub/sub ???????? ???? `channelName` ?? ??? ? publish ?? write connection ????? ????.
- ???? ??????? `keepDataInMemory` ? invalidate ??? cache?? ?? ?? ??.
- ??? bulk write timeout ???????? ??????? `maxChunkSizeInBytes` ?? ???? ??.
- DB size ????? ????? ???? ???????? ???????? ??? `DBSIZE` ?? ???? ????.

---

## ????
- Target framework: .NET 9
- Redis client: StackExchange.Redis 2.7.x

---

## ??????
MIT

## ??????
Issue ? PR ????? ?????????? ??????.
